<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ˆæ¡ˆè©³æƒ… - Team Task Manager</title>
  <link rel="stylesheet" href="../style/style.css">
</head>
<body>
  <div class="navbar">
    <h1>Team Task Manager</h1>
    <div class="nav-right">
      <button onclick="goBack()" class="btn-secondary">â† è¿”å›</button>
      <button onclick="logout()" class="btn-secondary">ç™»å‡º</button>
    </div>
  </div>

  <div class="container">
    <!-- å°ˆæ¡ˆè³‡è¨Š -->
    <div class="project-header">
      <div>
        <h2 id="project-name"></h2>
        <p id="project-description"></p>
      </div>
      <button onclick="showAddTaskModal()" class="btn-primary">+ æ–°å¢ä»»å‹™</button>
    </div>

    <!-- æˆå“¡åˆ—è¡¨ -->
    <div class="section">
      <h3>åœ˜éšŠæˆå“¡ <button onclick="showAddMemberModal()" class="btn-small">+ é‚€è«‹</button></h3>
      <div id="members-container" class="members-list"></div>
    </div>

    <!-- ä»»å‹™åˆ—è¡¨ -->
    <div class="section">
      <h3>ä»»å‹™åˆ—è¡¨</h3>
      <div class="task-filters">
        <button onclick="filterTasks('all')" class="filter-btn active">å…¨éƒ¨</button>
        <button onclick="filterTasks('todo')" class="filter-btn">å¾…è™•ç†</button>
        <button onclick="filterTasks('in_progress')" class="filter-btn">é€²è¡Œä¸­</button>
        <button onclick="filterTasks('done')" class="filter-btn">å·²å®Œæˆ</button>
      </div>
      <div id="tasks-container" class="tasks-list"></div>
    </div>

    <!-- æ–°å¢ä»»å‹™ Modal -->
    <div id="add-task-modal" class="modal hidden">
      <div class="modal-content">
        <h3>æ–°å¢ä»»å‹™</h3>
        <input type="text" id="task-title" placeholder="ä»»å‹™æ¨™é¡Œ" required>
        <textarea id="task-description" placeholder="ä»»å‹™æè¿° (é¸å¡«)" rows="3"></textarea>
        <select id="task-assignee">
          <option value="">ä¸æŒ‡æ´¾</option>
        </select>
        <select id="task-priority">
          <option value="low">ä½å„ªå…ˆç´š</option>
          <option value="medium" selected>ä¸­å„ªå…ˆç´š</option>
          <option value="high">é«˜å„ªå…ˆç´š</option>
        </select>
        <input type="date" id="task-due-date">
        <div class="modal-actions">
          <button onclick="createTask()" class="btn-primary">å»ºç«‹</button>
          <button onclick="hideTaskModal()" class="btn-secondary">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- é‚€è«‹æˆå“¡ Modal -->
    <div id="add-member-modal" class="modal hidden">
      <div class="modal-content">
        <h3>é‚€è«‹æˆå“¡</h3>
        <input type="email" id="member-email" placeholder="æˆå“¡ Email" required>
        <select id="member-role">
          <option value="member">ä¸€èˆ¬æˆå“¡</option>
          <option value="admin">ç®¡ç†å“¡</option>
        </select>
        <div class="modal-actions">
          <button onclick="addMember()" class="btn-primary">é‚€è«‹</button>
          <button onclick="hideMemberModal()" class="btn-secondary">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://team-task-manager-lr5e.onrender.com';
    let token = localStorage.getItem('token');
    let user = JSON.parse(localStorage.getItem('user'));
    let projectId = new URLSearchParams(window.location.search).get('id');
    let currentFilter = 'all';
    let projectData = null;
    let tasksData = [];

    if (!token || !projectId) {
      window.location.href = 'index.html';
    }

    // è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
    async function loadProject() {
      try {
        const response = await fetch(`${API_URL}/projects/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        projectData = await response.json();
        displayProject(projectData);
        displayMembers(projectData.members);
        displayTasks(projectData.tasks);
        tasksData = projectData.tasks;
      } catch (error) {
        alert('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—');
      }
    }

    // é¡¯ç¤ºå°ˆæ¡ˆè³‡è¨Š
    function displayProject(project) {
      document.getElementById('project-name').textContent = project.name;
      document.getElementById('project-description').textContent = project.description || 'æ²’æœ‰æè¿°';
    }

    // é¡¯ç¤ºæˆå“¡
    function displayMembers(members) {
      const container = document.getElementById('members-container');
      container.innerHTML = members.map(member => `
        <div class="member-item">
          <span>${member.username} (${member.email})</span>
          <span class="badge ${member.role === 'admin' ? 'badge-admin' : 'badge-member'}">
            ${member.role === 'admin' ? 'ç®¡ç†å“¡' : 'æˆå“¡'}
          </span>
        </div>
      `).join('');

      // æ›´æ–°ä»»å‹™æŒ‡æ´¾ä¸‹æ‹‰é¸å–®
      const assigneeSelect = document.getElementById('task-assignee');
      assigneeSelect.innerHTML = '<option value="">ä¸æŒ‡æ´¾</option>' + 
        members.map(m => `<option value="${m.id}">${m.username}</option>`).join('');
    }

    // é¡¯ç¤ºä»»å‹™
    function displayTasks(tasks) {
      const container = document.getElementById('tasks-container');
      
      if (tasks.length === 0) {
        container.innerHTML = '<p class="empty-state">é‚„æ²’æœ‰ä»»å‹™</p>';
        return;
      }

      container.innerHTML = tasks.map(task => `
        <div class="task-item ${task.status}">
          <div class="task-header">
            <h4>${task.title}</h4>
            <select onchange="updateTaskStatus(${task.id}, this.value)" class="status-select">
              <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>å¾…è™•ç†</option>
              <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>é€²è¡Œä¸­</option>
              <option value="done" ${task.status === 'done' ? 'selected' : ''}>å·²å®Œæˆ</option>
            </select>
          </div>
          <p class="task-desc">${task.description || 'æ²’æœ‰æè¿°'}</p>
          <div class="task-meta">
            <span class="badge badge-${task.priority}">${getPriorityText(task.priority)}</span>
            ${task.assigned_to ? `<span>ğŸ‘¤ ${task.assigned_to.username}</span>` : '<span>æœªæŒ‡æ´¾</span>'}
            ${task.due_date ? `<span>ğŸ“… ${formatDate(task.due_date)}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    // ç¯©é¸ä»»å‹™
    function filterTasks(status) {
      currentFilter = status;
      
      // æ›´æ–°æŒ‰éˆ•æ¨£å¼
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // ç¯©é¸ä¸¦é¡¯ç¤º
      const filtered = status === 'all' 
        ? tasksData 
        : tasksData.filter(t => t.status === status);
      
      displayTasks(filtered);
    }

    // æ›´æ–°ä»»å‹™ç‹€æ…‹
    async function updateTaskStatus(taskId, newStatus) {
      try {
        const response = await fetch(`${API_URL}/tasks/${taskId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status: newStatus })
        });

        if (response.ok) {
          loadProject(); // é‡æ–°è¼‰å…¥
        }
      } catch (error) {
        alert('æ›´æ–°å¤±æ•—');
      }
    }

    // é¡¯ç¤ºæ–°å¢ä»»å‹™ Modal
    function showAddTaskModal() {
      document.getElementById('add-task-modal').classList.remove('hidden');
    }

    function hideTaskModal() {
      document.getElementById('add-task-modal').classList.add('hidden');
    }

    // å»ºç«‹ä»»å‹™
    async function createTask() {
      const title = document.getElementById('task-title').value;
      const description = document.getElementById('task-description').value;
      const assigned_to = document.getElementById('task-assignee').value;
      const priority = document.getElementById('task-priority').value;
      const due_date = document.getElementById('task-due-date').value;

      if (!title.trim()) {
        alert('è«‹è¼¸å…¥ä»»å‹™æ¨™é¡Œ');
        return;
      }

      const body = { title, description, priority };
      if (assigned_to) body.assigned_to = parseInt(assigned_to);
      if (due_date) body.due_date = due_date;

      try {
        const response = await fetch(`${API_URL}/projects/${projectId}/tasks`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          hideTaskModal();
          loadProject();
        } else {
          const data = await response.json();
          alert(data.error || 'å»ºç«‹å¤±æ•—');
        }
      } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤');
      }
    }

    // é¡¯ç¤ºé‚€è«‹æˆå“¡ Modal
    function showAddMemberModal() {
      document.getElementById('add-member-modal').classList.remove('hidden');
    }

    function hideMemberModal() {
      document.getElementById('add-member-modal').classList.add('hidden');
    }

    // é‚€è«‹æˆå“¡
    async function addMember() {
      const email = document.getElementById('member-email').value;
      const role = document.getElementById('member-role').value;

      if (!email) {
        alert('è«‹è¼¸å…¥ Email');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/projects/${projectId}/members`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ user_email: email, role })
        });

        if (response.ok) {
          hideMemberModal();
          loadProject();
        } else {
          const data = await response.json();
          alert(data.error || 'é‚€è«‹å¤±æ•—');
        }
      } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤');
      }
    }

    // è¼”åŠ©å‡½æ•¸
    function getPriorityText(priority) {
      const map = { low: 'ä½', medium: 'ä¸­', high: 'é«˜' };
      return map[priority] || priority;
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('zh-TW');
    }

    function goBack() {
      window.location.href = 'dashboard.html';
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }

    // é é¢è¼‰å…¥
    loadProject();
  </script>
</body>
</html>