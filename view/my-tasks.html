<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„ä»»å‹™ - Team Task Manager</title>
  <link rel="stylesheet" href="./style/style.css">
</head>
<body>
  <div class="navbar">
    <h1>Team Task Manager</h1>
    <div class="nav-right">
      <button onclick="goToDashboard()" class="btn-secondary">â† è¿”å›</button>
      <button onclick="logout()" class="btn-secondary">ç™»å‡º</button>
    </div>
  </div>

  <div class="container">
    <div class="my-tasks-header">
      <div>
        <h2>æˆ‘çš„ä»»å‹™</h2>
        <p style="color: #666; margin-top: 0.5rem;">
          å…± <span id="total-tasks">0</span> å€‹ä»»å‹™
        </p>
      </div>
      
      <div class="task-filters">
        <button onclick="filterTasks('all')" class="filter-btn active" data-status="all">
          å…¨éƒ¨
        </button>
        <button onclick="filterTasks('todo')" class="filter-btn" data-status="todo">
          å¾…è™•ç†
        </button>
        <button onclick="filterTasks('in_progress')" class="filter-btn" data-status="in_progress">
          é€²è¡Œä¸­
        </button>
        <button onclick="filterTasks('done')" class="filter-btn" data-status="done">
          å·²å®Œæˆ
        </button>
      </div>
    </div>

    <!-- ä»»å‹™åˆ—è¡¨å®¹å™¨ -->
    <div id="tasks-container"></div>
  </div>

  <!-- å¼•å…¥ JS -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/utils.js"></script>
  
  <script>
    let allTasks = [];
    let currentFilter = 'all';

    // è¼‰å…¥æˆ‘çš„ä»»å‹™
    async function loadMyTasks() {
      try {
        Utils.showLoading('è¼‰å…¥ä»»å‹™ä¸­...');
        const data = await TaskAPI.myTasks();
        
        allTasks = data.tasks || [];
        displayTasks(allTasks);
        updateTaskCount();
        
      } catch (error) {
        console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', error);
        Utils.showError(error.message || 'è¼‰å…¥ä»»å‹™å¤±æ•—');
        document.getElementById('tasks-container').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ˜”</div>
            <div class="empty-state-text">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          </div>
        `;
      } finally {
        Utils.hideLoading();
      }
    }

    // é¡¯ç¤ºä»»å‹™ï¼ˆæŒ‰å°ˆæ¡ˆåˆ†çµ„ï¼‰
    function displayTasks(tasks) {
      const container = document.getElementById('tasks-container');
      
      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-text">
              ${currentFilter === 'all' ? 'é‚„æ²’æœ‰ä»»å‹™' : 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä»»å‹™'}
            </div>
          </div>
        `;
        return;
      }

      // æŒ‰å°ˆæ¡ˆåˆ†çµ„
      const tasksByProject = tasks.reduce((acc, task) => {
        const projectId = task.project.id;
        if (!acc[projectId]) {
          acc[projectId] = {
            project: task.project,
            tasks: []
          };
        }
        acc[projectId].tasks.push(task);
        return acc;
      }, {});

      // ç”¢ç”Ÿ HTML
      container.innerHTML = Object.values(tasksByProject).map(group => {
        const { project, tasks } = group;
        
        return `
          <div class="task-group">
            <div class="task-group-header">
              <div class="task-group-title">
                ğŸ“ ${Utils.escapeHtml(project.name)}
              </div>
              <div class="task-group-count">${tasks.length}</div>
            </div>
            
            <div class="tasks-list">
              ${tasks.map(task => createTaskHTML(task)).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // å»ºç«‹å–®å€‹ä»»å‹™ HTML
    function createTaskHTML(task) {
      return `
        <div class="task-item ${task.status}" data-task-id="${task.id}">
          <div class="task-header">
            <h4>${Utils.escapeHtml(task.title)}</h4>
            <div class="task-actions">
              <select onchange="updateTaskStatus(${task.id}, this.value)" 
                      class="status-select">
                <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>
                  å¾…è™•ç†
                </option>
                <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>
                  é€²è¡Œä¸­
                </option>
                <option value="done" ${task.status === 'done' ? 'selected' : ''}>
                  å·²å®Œæˆ
                </option>
              </select>
              <button class="btn-icon" onclick="goToProject(${task.project.id})" 
                      title="å‰å¾€å°ˆæ¡ˆ">
                ğŸ”—
              </button>
            </div>
          </div>
          
          ${task.description ? `
            <p class="task-desc">${Utils.escapeHtml(task.description)}</p>
          ` : ''}
          
          <div class="task-meta">
            <span class="badge ${Utils.getPriorityClass(task.priority)}">
              ${Utils.getTaskPriorityText(task.priority)}
            </span>
            
            ${task.due_date ? `
              <span title="æˆªæ­¢æ—¥æœŸ">
                ğŸ“… ${Utils.formatDate(task.due_date)}
              </span>
            ` : ''}
            
            ${task.created_by ? `
              <span title="å»ºç«‹è€…">
                ğŸ‘¤ ${Utils.escapeHtml(task.created_by.username)}
              </span>
            ` : ''}
            
            <span title="å»ºç«‹æ™‚é–“" style="color: #999;">
              ${Utils.formatDate(task.created_at, 'relative')}
            </span>
          </div>
        </div>
      `;
    }

    // ç¯©é¸ä»»å‹™
    function filterTasks(status) {
      currentFilter = status;
      
      // æ›´æ–°æŒ‰éˆ•æ¨£å¼
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // ç¯©é¸ä¸¦é¡¯ç¤º
      const filteredTasks = status === 'all' 
        ? allTasks 
        : allTasks.filter(t => t.status === status);
      
      displayTasks(filteredTasks);
      updateTaskCount();
    }

    // æ›´æ–°ä»»å‹™ç‹€æ…‹
    async function updateTaskStatus(taskId, newStatus) {
      try {
        await TaskAPI.update(taskId, { status: newStatus });
        
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        const task = allTasks.find(t => t.id === taskId);
        if (task) {
          task.status = newStatus;
          
          // å¦‚æœæ˜¯å®Œæˆç‹€æ…‹ï¼Œè¨˜éŒ„å®Œæˆæ™‚é–“
          if (newStatus === CONFIG.TASK_STATUS.DONE) {
            task.completed_at = new Date().toISOString();
          }
          
          // é‡æ–°é¡¯ç¤º
          filterTasks(currentFilter);
        }
        
        Utils.showSuccess('ä»»å‹™ç‹€æ…‹å·²æ›´æ–°');
        
      } catch (error) {
        console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
        Utils.showError(error.message || 'æ›´æ–°ç‹€æ…‹å¤±æ•—');
        // é‡æ–°è¼‰å…¥ä»¥æ¢å¾©åŸç‹€æ…‹
        loadMyTasks();
      }
    }

    // æ›´æ–°ä»»å‹™æ•¸é‡
    function updateTaskCount() {
      const filtered = currentFilter === 'all' 
        ? allTasks 
        : allTasks.filter(t => t.status === currentFilter);
      
      document.getElementById('total-tasks').textContent = filtered.length;
    }

    // å‰å¾€å°ˆæ¡ˆé é¢
    function goToProject(projectId) {
      window.location.href = `project.html?id=${projectId}`;
    }

    // è¿”å› Dashboard
    function goToDashboard() {
      window.location.href = 'dashboard.html';
    }

    // ç™»å‡º
    function logout() {
      Utils.confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', () => {
        api.clearAuth();
        window.location.href = 'index.html';
      });
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadMyTasks();
  </script>
</body>
</html> 