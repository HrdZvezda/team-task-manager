<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ˆæ¡ˆè©³æƒ… - Team Task Manager</title>
  <link rel="stylesheet" href="../style/style.css">
</head>
<body>
  <div class="navbar">
    <h1>Team Task Manager</h1>
    <div class="nav-right">
      <button onclick="goBack()" class="btn-secondary">â† è¿”å›</button>
      <button onclick="logout()" class="btn-secondary">ç™»å‡º</button>
    </div>
  </div>

  <div class="container">
    <!-- å°ˆæ¡ˆè³‡è¨Š -->
    <div class="project-header">
      <div>
        <h2 id="project-name"></h2>
        <p id="project-description"></p>
      </div>
      <div class="project-actions" id="project-actions">
        <!-- å‹•æ…‹æ’å…¥ç·¨è¼¯/åˆªé™¤æŒ‰éˆ• -->
      </div>
    </div>

    <!-- å°ˆæ¡ˆçµ±è¨ˆ -->
    <div class="project-stats">
      <div class="stat-card">
        <div class="stat-icon" style="background: #e3f2fd;">ğŸ“Š</div>
        <div class="stat-info">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">ç¸½ä»»å‹™æ•¸</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: #e8f5e9;">âœ…</div>
        <div class="stat-info">
          <div class="stat-value" id="stat-done">0</div>
          <div class="stat-label">å·²å®Œæˆ</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: #fff9e6;">â³</div>
        <div class="stat-info">
          <div class="stat-value" id="stat-in-progress">0</div>
          <div class="stat-label">é€²è¡Œä¸­</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: #fce4ec;">ğŸ“‹</div>
        <div class="stat-info">
          <div class="stat-value" id="stat-todo">0</div>
          <div class="stat-label">å¾…è™•ç†</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background: #ffebee;">âš ï¸</div>
        <div class="stat-info">
          <div class="stat-value" id="stat-overdue">0</div>
          <div class="stat-label">é€¾æœŸä»»å‹™</div>
        </div>
      </div>
    </div>

    <!-- æˆå“¡åˆ—è¡¨ -->
    <div class="section">
      <h3>
        åœ˜éšŠæˆå“¡
        <button onclick="showAddMemberModal()" class="btn-small" id="add-member-btn">
          + é‚€è«‹
        </button>
      </h3>
      <div id="members-container" class="members-list"></div>
    </div>

    <!-- ä»»å‹™åˆ—è¡¨ -->
    <div class="section">
      <h3>ä»»å‹™åˆ—è¡¨</h3>
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="task-filters">
          <button onclick="filterTasks('all')" class="filter-btn active" data-status="all">
            å…¨éƒ¨
          </button>
          <button onclick="filterTasks('todo')" class="filter-btn" data-status="todo">
            å¾…è™•ç†
          </button>
          <button onclick="filterTasks('in_progress')" class="filter-btn" data-status="in_progress">
            é€²è¡Œä¸­
          </button>
          <button onclick="filterTasks('done')" class="filter-btn" data-status="done">
            å·²å®Œæˆ
          </button>
        </div>
        
        <button onclick="showAddTaskModal()" class="btn-primary">+ æ–°å¢ä»»å‹™</button>
      </div>
      
      <div id="tasks-container" class="tasks-list"></div>
    </div>

    <!-- æ–°å¢ä»»å‹™ Modal -->
    <div id="add-task-modal" class="modal hidden">
      <div class="modal-content">
        <h3 id="task-modal-title">æ–°å¢ä»»å‹™</h3>
        <form id="task-form">
          <input type="hidden" id="edit-task-id">
          <input type="text" id="task-title" placeholder="ä»»å‹™æ¨™é¡Œ" required>
          <textarea id="task-description" placeholder="ä»»å‹™æè¿°ï¼ˆé¸å¡«ï¼‰" rows="3"></textarea>
          <select id="task-assignee">
            <option value="">ä¸æŒ‡æ´¾</option>
          </select>
          <select id="task-priority">
            <option value="low">ä½å„ªå…ˆç´š</option>
            <option value="medium" selected>ä¸­å„ªå…ˆç´š</option>
            <option value="high">é«˜å„ªå…ˆç´š</option>
          </select>
          <input type="date" id="task-due-date">
          <div class="modal-actions">
            <button type="submit" class="btn-primary" id="task-submit-btn">å»ºç«‹</button>
            <button type="button" onclick="hideTaskModal()" class="btn-secondary">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>

    <!-- é‚€è«‹æˆå“¡ Modal -->
    <div id="add-member-modal" class="modal hidden">
      <div class="modal-content">
        <h3>é‚€è«‹æˆå“¡</h3>
        <form id="member-form">
          <input type="email" id="member-email" placeholder="æˆå“¡ Email" required>
          <select id="member-role">
            <option value="member">ä¸€èˆ¬æˆå“¡</option>
            <option value="admin">ç®¡ç†å“¡</option>
          </select>
          <div class="modal-actions">
            <button type="submit" class="btn-primary">é‚€è«‹</button>
            <button type="button" onclick="hideMemberModal()" class="btn-secondary">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç·¨è¼¯å°ˆæ¡ˆ Modal -->
    <div id="edit-project-modal" class="modal hidden">
      <div class="modal-content">
        <h3>ç·¨è¼¯å°ˆæ¡ˆ</h3>
        <form id="edit-project-form">
          <input type="text" id="edit-project-name" placeholder="å°ˆæ¡ˆåç¨±" required>
          <textarea id="edit-project-description" placeholder="å°ˆæ¡ˆæè¿°" rows="3"></textarea>
          <div class="modal-actions">
            <button type="submit" class="btn-primary">å„²å­˜</button>
            <button type="button" onclick="hideEditProjectModal()" class="btn-secondary">
              å–æ¶ˆ
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ä»»å‹™è©³æƒ… Modal (å«è©•è«–) -->
    <div id="task-detail-modal" class="modal hidden">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3 id="detail-modal-title">ä»»å‹™è©³æƒ…</h3>
          <button class="modal-close" onclick="hideTaskDetailModal()">âœ•</button>
        </div>
        
        <div class="task-detail-modal-body">
          <!-- ä»»å‹™è³‡è¨Š -->
          <div class="task-info-section">
            <div class="info-row">
              <label>ç‹€æ…‹</label>
              <select id="detail-task-status" onchange="updateTaskStatus()">
                <option value="todo">å¾…è™•ç†</option>
                <option value="in_progress">é€²è¡Œä¸­</option>
                <option value="done">å·²å®Œæˆ</option>
              </select>
            </div>
            
            <div class="info-row">
              <label>å„ªå…ˆç´š</label>
              <span id="detail-task-priority" class="priority-badge"></span>
            </div>
            
            <div class="info-row">
              <label>è² è²¬äºº</label>
              <span id="detail-task-assignee">æœªæŒ‡æ´¾</span>
            </div>
            
            <div class="info-row">
              <label>æˆªæ­¢æ—¥æœŸ</label>
              <span id="detail-task-due-date">æœªè¨­å®š</span>
            </div>
            
            <div class="info-row">
              <label>æè¿°</label>
              <p id="detail-task-description">ç„¡æè¿°</p>
            </div>
          </div>

          <!-- è©•è«–å€å¡Š -->
          <div class="comments-section">
            <h4>è©•è«– <span id="comments-count-badge">(0)</span></h4>
            
            <!-- è©•è«–åˆ—è¡¨ -->
            <div id="task-comments-list" class="task-comments-list">
              <div class="loading-comments">è¼‰å…¥è©•è«–ä¸­...</div>
            </div>
            
            <!-- æ–°å¢è©•è«– -->
            <div class="add-comment-form">
              <textarea 
                id="new-comment-text" 
                placeholder="æ–°å¢è©•è«–..." 
                rows="3"
              ></textarea>
              <button 
                class="btn-primary" 
                onclick="addTaskComment()"
              >
                ç™¼é€è©•è«–
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥ JS -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/utils.js"></script>
  
  <script>
    const user = Utils.getCurrentUser();
    const projectId = Utils.getQueryParam('id');
    
    let projectData = null;
    let allTasks = [];
    let currentFilter = 'all';
    let currentTaskId = null; // ç•¶å‰æŸ¥çœ‹çš„ä»»å‹™ ID

    if (!projectId) {
      Utils.showError('ç„¡æ•ˆçš„å°ˆæ¡ˆ ID');
      setTimeout(() => window.location.href = 'dashboard.html', 2000);
    }

    // è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
    async function loadProject() {
      try {
        Utils.showLoading('è¼‰å…¥å°ˆæ¡ˆä¸­...');
        projectData = await ProjectAPI.get(projectId);
        
        displayProject(projectData);
        displayMembers(projectData.members || []);
        displayTasks(projectData.tasks || []);
        updateProjectActions();
        loadProjectStats(); // è¼‰å…¥çµ±è¨ˆ
        
        allTasks = projectData.tasks || [];
        
      } catch (error) {
        console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', error);
        Utils.showError(error.message || 'è¼‰å…¥å°ˆæ¡ˆå¤±æ•—');
        setTimeout(() => window.location.href = 'dashboard.html', 2000);
      } finally {
        Utils.hideLoading();
      }
    }

    // è¼‰å…¥å°ˆæ¡ˆçµ±è¨ˆ
    async function loadProjectStats() {
      try {
        const response = await fetch(`${API_BASE_URL}/projects/${projectId}/stats`, {
          headers: Utils.getAuthHeaders()
        });

        let stats;
        if (!response.ok) {
          // å¦‚æœ API ä¸å­˜åœ¨,å¾æœ¬åœ°ä»»å‹™è¨ˆç®—çµ±è¨ˆ
          stats = calculateLocalStats(allTasks);
        } else {
          stats = await response.json();
        }

        // æ›´æ–°çµ±è¨ˆå¡ç‰‡
        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-done').textContent = stats.done || 0;
        document.getElementById('stat-in-progress').textContent = stats.in_progress || 0;
        document.getElementById('stat-todo').textContent = stats.todo || 0;
        document.getElementById('stat-overdue').textContent = stats.overdue || 0;

      } catch (error) {
        console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
        // å¤±æ•—æ™‚ä½¿ç”¨æœ¬åœ°è¨ˆç®—
        const stats = calculateLocalStats(allTasks);
        document.getElementById('stat-total').textContent = stats.total || 0;
        document.getElementById('stat-done').textContent = stats.done || 0;
        document.getElementById('stat-in-progress').textContent = stats.in_progress || 0;
        document.getElementById('stat-todo').textContent = stats.todo || 0;
        document.getElementById('stat-overdue').textContent = stats.overdue || 0;
      }
    }

    // å¾æœ¬åœ°ä»»å‹™è¨ˆç®—çµ±è¨ˆ
    function calculateLocalStats(tasks) {
      const now = new Date();
      
      return {
        total: tasks.length,
        done: tasks.filter(t => t.status === 'done').length,
        in_progress: tasks.filter(t => t.status === 'in_progress').length,
        todo: tasks.filter(t => t.status === 'todo').length,
        overdue: tasks.filter(t => 
          t.due_date && 
          new Date(t.due_date) < now && 
          t.status !== 'done'
        ).length
      };
    }

    // é¡¯ç¤ºå°ˆæ¡ˆè³‡è¨Š
    function displayProject(project) {
      document.getElementById('project-name').textContent = project.name;
      document.getElementById('project-description').textContent = 
        project.description || 'æ²’æœ‰æè¿°';
    }

    // æ›´æ–°å°ˆæ¡ˆæ“ä½œæŒ‰éˆ•ï¼ˆç·¨è¼¯/åˆªé™¤ï¼‰
    function updateProjectActions() {
      const actionsContainer = document.getElementById('project-actions');
      
      // åªæœ‰ owner å’Œ admin èƒ½ç·¨è¼¯
      const canEdit = projectData.owner_id === user.id || 
                     projectData.my_role === 'admin';
      
      // åªæœ‰ owner èƒ½åˆªé™¤
      const canDelete = projectData.owner_id === user.id;

      let html = '';
      
      if (canEdit) {
        html += `
          <button onclick="showEditProjectModal()" class="btn-secondary">
            âœï¸ ç·¨è¼¯
          </button>
        `;
      }
      
      if (canDelete) {
        html += `
          <button onclick="deleteProject()" class="btn-secondary" 
                  style="color: #ff4444;">
            ğŸ—‘ï¸ åˆªé™¤
          </button>
        `;
      }
      
      actionsContainer.innerHTML = html;
    }

    // é¡¯ç¤ºæˆå“¡
    function displayMembers(members) {
      const container = document.getElementById('members-container');
      
      if (members.length === 0) {
        container.innerHTML = '<p class="text-muted">é‚„æ²’æœ‰æˆå“¡</p>';
        return;
      }

      container.innerHTML = members.map(member => {
        const roleText = member.role === 'admin' ? 'ç®¡ç†å“¡' : 'æˆå“¡';
        const roleClass = member.role === 'admin' ? 'badge-admin' : 'badge-member';
        
        return `
          <div class="member-item">
            <span>
              ${Utils.escapeHtml(member.username)} 
              (${Utils.escapeHtml(member.email)})
            </span>
            <span class="badge ${roleClass}">${roleText}</span>
          </div>
        `;
      }).join('');

      // æ›´æ–°ä»»å‹™æŒ‡æ´¾ä¸‹æ‹‰é¸å–®
      const assigneeSelect = document.getElementById('task-assignee');
      assigneeSelect.innerHTML = '<option value="">ä¸æŒ‡æ´¾</option>' + 
        members.map(m => 
          `<option value="${m.id}">${Utils.escapeHtml(m.username)}</option>`
        ).join('');
    }

    // é¡¯ç¤ºä»»å‹™
    function displayTasks(tasks) {
      const container = document.getElementById('tasks-container');
      
      if (tasks.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-text">é‚„æ²’æœ‰ä»»å‹™</div>
          </div>
        `;
        return;
      }

      container.innerHTML = tasks.map(task => createTaskHTML(task)).join('');
    }

    // å»ºç«‹å–®å€‹ä»»å‹™ HTML
    function createTaskHTML(task) {
      return `
        <div class="task-item ${task.status}" data-task-id="${task.id}" onclick="showTaskDetail(${task.id})">
          <div class="task-header">
            <h4>${Utils.escapeHtml(task.title)}</h4>
            <div class="task-actions" onclick="event.stopPropagation()">
              <select onchange="updateTaskStatusQuick(${task.id}, this.value)" 
                      class="status-select">
                <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>
                  å¾…è™•ç†
                </option>
                <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>
                  é€²è¡Œä¸­
                </option>
                <option value="done" ${task.status === 'done' ? 'selected' : ''}>
                  å·²å®Œæˆ
                </option>
              </select>
              <button class="btn-icon" onclick="event.stopPropagation(); editTask(${task.id})" title="ç·¨è¼¯">
                âœï¸
              </button>
              <button class="btn-icon delete" onclick="event.stopPropagation(); deleteTask(${task.id})" title="åˆªé™¤">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
          
          ${task.description ? `
            <p class="task-desc">${Utils.escapeHtml(task.description)}</p>
          ` : ''}
          
          <div class="task-meta">
            <span class="badge ${Utils.getPriorityClass(task.priority)}">
              ${Utils.getTaskPriorityText(task.priority)}
            </span>
            
            ${task.assigned_to ? `
              <span>ğŸ‘¤ ${Utils.escapeHtml(task.assigned_to.username)}</span>
            ` : '<span>æœªæŒ‡æ´¾</span>'}
            
            ${task.due_date ? `
              <span>ğŸ“… ${Utils.formatDate(task.due_date)}</span>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ç¯©é¸ä»»å‹™
    function filterTasks(status) {
      currentFilter = status;
      
      // æ›´æ–°æŒ‰éˆ•æ¨£å¼
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) {
          btn.classList.add('active');
        }
      });

      // ç¯©é¸ä¸¦é¡¯ç¤º
      const filtered = status === 'all' 
        ? allTasks 
        : allTasks.filter(t => t.status === status);
      
      displayTasks(filtered);
    }

    // æ›´æ–°ä»»å‹™ç‹€æ…‹
    async function updateTaskStatus(taskId, newStatus) {
      try {
        await TaskAPI.update(taskId, { status: newStatus });
        
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        const task = allTasks.find(t => t.id === taskId);
        if (task) {
          task.status = newStatus;
          filterTasks(currentFilter);
        }
        
        Utils.showSuccess('ä»»å‹™ç‹€æ…‹å·²æ›´æ–°');
        
      } catch (error) {
        console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
        Utils.showError(error.message || 'æ›´æ–°ç‹€æ…‹å¤±æ•—');
        loadProject();
      }
    }

    // é¡¯ç¤ºæ–°å¢ä»»å‹™ Modal
    function showAddTaskModal() {
      document.getElementById('task-modal-title').textContent = 'æ–°å¢ä»»å‹™';
      document.getElementById('task-submit-btn').textContent = 'å»ºç«‹';
      document.getElementById('edit-task-id').value = '';
      document.getElementById('task-form').reset();
      document.getElementById('add-task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    // éš±è—ä»»å‹™ Modal
    function hideTaskModal() {
      document.getElementById('add-task-modal').classList.add('hidden');
      document.getElementById('task-form').reset();
    }

    // å»ºç«‹/æ›´æ–°ä»»å‹™
    document.getElementById('task-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const taskId = document.getElementById('edit-task-id').value;
      const title = document.getElementById('task-title').value.trim();
      const description = document.getElementById('task-description').value.trim();
      const assignedTo = document.getElementById('task-assignee').value;
      const priority = document.getElementById('task-priority').value;
      const dueDate = document.getElementById('task-due-date').value;

      if (!title) {
        Utils.showError('è«‹è¼¸å…¥ä»»å‹™æ¨™é¡Œ');
        return;
      }

      const taskData = { 
        title, 
        description, 
        priority 
      };
      
      if (assignedTo) taskData.assigned_to = parseInt(assignedTo);
      if (dueDate) taskData.due_date = dueDate;

      try {
        Utils.showLoading(taskId ? 'æ›´æ–°ä¸­...' : 'å»ºç«‹ä¸­...');
        
        if (taskId) {
          // æ›´æ–°ä»»å‹™
          await TaskAPI.update(taskId, taskData);
          Utils.showSuccess('ä»»å‹™å·²æ›´æ–°');
        } else {
          // å»ºç«‹ä»»å‹™
          await TaskAPI.create(projectId, taskData);
          Utils.showSuccess('ä»»å‹™å·²å»ºç«‹');
        }
        
        hideTaskModal();
        loadProject();
        
      } catch (error) {
        console.error('æ“ä½œå¤±æ•—:', error);
        Utils.showError(error.message || 'æ“ä½œå¤±æ•—');
      } finally {
        Utils.hideLoading();
      }
    });

    // ç·¨è¼¯ä»»å‹™
    function editTask(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      document.getElementById('task-modal-title').textContent = 'ç·¨è¼¯ä»»å‹™';
      document.getElementById('task-submit-btn').textContent = 'æ›´æ–°';
      document.getElementById('edit-task-id').value = taskId;
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-description').value = task.description || '';
      document.getElementById('task-assignee').value = task.assigned_to?.id || '';
      document.getElementById('task-priority').value = task.priority;
      document.getElementById('task-due-date').value = task.due_date || '';
      
      document.getElementById('add-task-modal').classList.remove('hidden');
      document.getElementById('task-title').focus();
    }

    // åˆªé™¤ä»»å‹™
    function deleteTask(taskId) {
      Utils.confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿ', async () => {
        try {
          Utils.showLoading('åˆªé™¤ä¸­...');
          await TaskAPI.delete(taskId);
          
          Utils.showSuccess('ä»»å‹™å·²åˆªé™¤');
          loadProject();
          
        } catch (error) {
          console.error('åˆªé™¤å¤±æ•—:', error);
          Utils.showError(error.message || 'åˆªé™¤å¤±æ•—');
        } finally {
          Utils.hideLoading();
        }
      });
    }

    // é¡¯ç¤ºé‚€è«‹æˆå“¡ Modal
    function showAddMemberModal() {
      document.getElementById('add-member-modal').classList.remove('hidden');
      document.getElementById('member-email').focus();
    }

    // éš±è—æˆå“¡ Modal
    function hideMemberModal() {
      document.getElementById('add-member-modal').classList.add('hidden');
      document.getElementById('member-form').reset();
    }

    // é‚€è«‹æˆå“¡
    document.getElementById('member-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('member-email').value.trim();
      const role = document.getElementById('member-role').value;

      if (!email) {
        Utils.showError('è«‹è¼¸å…¥ Email');
        return;
      }

      if (!Utils.isValidEmail(email)) {
        Utils.showError('Email æ ¼å¼ä¸æ­£ç¢º');
        return;
      }

      try {
        Utils.showLoading('é‚€è«‹ä¸­...');
        await ProjectAPI.addMember(projectId, { 
          user_email: email, 
          role 
        });
        
        Utils.showSuccess('æˆå“¡å·²é‚€è«‹');
        hideMemberModal();
        loadProject();
        
      } catch (error) {
        console.error('é‚€è«‹å¤±æ•—:', error);
        Utils.showError(error.message || 'é‚€è«‹å¤±æ•—');
      } finally {
        Utils.hideLoading();
      }
    });

    // é¡¯ç¤ºç·¨è¼¯å°ˆæ¡ˆ Modal
    function showEditProjectModal() {
      document.getElementById('edit-project-name').value = projectData.name;
      document.getElementById('edit-project-description').value = projectData.description || '';
      document.getElementById('edit-project-modal').classList.remove('hidden');
      document.getElementById('edit-project-name').focus();
    }

    // éš±è—ç·¨è¼¯å°ˆæ¡ˆ Modal
    function hideEditProjectModal() {
      document.getElementById('edit-project-modal').classList.add('hidden');
      document.getElementById('edit-project-form').reset();
    }

    // æ›´æ–°å°ˆæ¡ˆ
    document.getElementById('edit-project-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('edit-project-name').value.trim();
      const description = document.getElementById('edit-project-description').value.trim();

      if (!name) {
        Utils.showError('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
        return;
      }

      try {
        Utils.showLoading('æ›´æ–°ä¸­...');
        await ProjectAPI.update(projectId, { name, description });
        
        Utils.showSuccess('å°ˆæ¡ˆå·²æ›´æ–°');
        hideEditProjectModal();
        loadProject();
        
      } catch (error) {
        console.error('æ›´æ–°å¤±æ•—:', error);
        Utils.showError(error.message || 'æ›´æ–°å¤±æ•—');
      } finally {
        Utils.hideLoading();
      }
    });

    // åˆªé™¤å°ˆæ¡ˆ
    function deleteProject() {
      Utils.confirm(
        'ç¢ºå®šè¦åˆªé™¤é€™å€‹å°ˆæ¡ˆå—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼Œæ‰€æœ‰ç›¸é—œçš„ä»»å‹™ä¹Ÿæœƒè¢«åˆªé™¤ã€‚',
        async () => {
          try {
            Utils.showLoading('åˆªé™¤ä¸­...');
            await ProjectAPI.delete(projectId);
            
            Utils.showSuccess('å°ˆæ¡ˆå·²åˆªé™¤');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
            
          } catch (error) {
            console.error('åˆªé™¤å¤±æ•—:', error);
            Utils.showError(error.message || 'åˆªé™¤å¤±æ•—');
            Utils.hideLoading();
          }
        }
      );
    }

    // è¿”å›
    function goBack() {
      window.location.href = 'dashboard.html';
    }

    // ========== ä»»å‹™è©³æƒ…å’Œè©•è«–åŠŸèƒ½ ==========
    
    // é¡¯ç¤ºä»»å‹™è©³æƒ… Modal
    async function showTaskDetail(taskId) {
      currentTaskId = taskId;
      const task = allTasks.find(t => t.id === taskId);
      
      if (!task) {
        Utils.showError('æ‰¾ä¸åˆ°ä»»å‹™');
        return;
      }

      // å¡«å…¥ä»»å‹™è³‡è¨Š
      document.getElementById('detail-modal-title').textContent = task.title;
      document.getElementById('detail-task-status').value = task.status;
      document.getElementById('detail-task-priority').textContent = 
        Utils.getTaskPriorityText(task.priority);
      document.getElementById('detail-task-assignee').textContent = 
        task.assigned_to ? task.assigned_to.username : 'æœªæŒ‡æ´¾';
      document.getElementById('detail-task-due-date').textContent = 
        task.due_date ? Utils.formatDate(task.due_date) : 'æœªè¨­å®š';
      document.getElementById('detail-task-description').textContent = 
        task.description || 'ç„¡æè¿°';

      // é¡¯ç¤º Modal
      document.getElementById('task-detail-modal').classList.remove('hidden');

      // è¼‰å…¥è©•è«–
      await loadTaskComments(taskId);
    }

    // éš±è—ä»»å‹™è©³æƒ… Modal
    function hideTaskDetailModal() {
      document.getElementById('task-detail-modal').classList.add('hidden');
      currentTaskId = null;
    }

    // æ›´æ–°ä»»å‹™ç‹€æ…‹ (å¾è©³æƒ… Modal)
    async function updateTaskStatus() {
      if (!currentTaskId) return;

      const newStatus = document.getElementById('detail-task-status').value;

      try {
        await TaskAPI.update(currentTaskId, { status: newStatus });
        Utils.showSuccess('ç‹€æ…‹å·²æ›´æ–°');
        
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        const task = allTasks.find(t => t.id === currentTaskId);
        if (task) {
          task.status = newStatus;
        }
        
        // é‡æ–°é¡¯ç¤ºä»»å‹™åˆ—è¡¨
        filterTasks(currentFilter);
        
      } catch (error) {
        console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
        Utils.showError('æ›´æ–°ç‹€æ…‹å¤±æ•—');
      }
    }

    // å¿«é€Ÿæ›´æ–°ä»»å‹™ç‹€æ…‹ (å¾ä»»å‹™å¡ç‰‡)
    async function updateTaskStatusQuick(taskId, newStatus) {
      try {
        await TaskAPI.update(taskId, { status: newStatus });
        Utils.showSuccess('ç‹€æ…‹å·²æ›´æ–°');
        
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        const task = allTasks.find(t => t.id === taskId);
        if (task) {
          task.status = newStatus;
        }
        
        // é‡æ–°é¡¯ç¤ºä»»å‹™åˆ—è¡¨
        filterTasks(currentFilter);
        
      } catch (error) {
        console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
        Utils.showError('æ›´æ–°ç‹€æ…‹å¤±æ•—');
      }
    }

    // è¼‰å…¥ä»»å‹™è©•è«–
    async function loadTaskComments(taskId) {
      const commentsList = document.getElementById('task-comments-list');
      
      try {
        commentsList.innerHTML = '<div class="loading-comments">è¼‰å…¥è©•è«–ä¸­...</div>';
        
        const response = await fetch(`${API_BASE_URL}/tasks/${taskId}/comments`, {
          headers: Utils.getAuthHeaders()
        });

        if (!response.ok) {
          // å¦‚æœ API ä¸å­˜åœ¨,é¡¯ç¤ºç©ºç‹€æ…‹
          commentsList.innerHTML = '<div class="empty-comments">æš«ç„¡è©•è«–</div>';
          document.getElementById('comments-count-badge').textContent = '(0)';
          return;
        }

        const comments = await response.json();
        
        // æ›´æ–°è©•è«–æ•¸é‡
        document.getElementById('comments-count-badge').textContent = `(${comments.length})`;
        
        if (comments.length === 0) {
          commentsList.innerHTML = '<div class="empty-comments">æš«ç„¡è©•è«–ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººï¼</div>';
          return;
        }

        // é¡¯ç¤ºè©•è«–
        commentsList.innerHTML = comments.map(comment => `
          <div class="comment-item">
            <div class="comment-header">
              <div class="comment-avatar">${comment.user.username.charAt(0).toUpperCase()}</div>
              <div class="comment-meta">
                <span class="comment-author">${Utils.escapeHtml(comment.user.username)}</span>
                <span class="comment-time">${Utils.formatRelativeTime(comment.created_at)}</span>
              </div>
            </div>
            <div class="comment-body">${Utils.escapeHtml(comment.content)}</div>
          </div>
        `).join('');

      } catch (error) {
        console.error('è¼‰å…¥è©•è«–å¤±æ•—:', error);
        commentsList.innerHTML = '<div class="error-comments">è¼‰å…¥è©•è«–å¤±æ•—</div>';
      }
    }

    // æ–°å¢è©•è«–
    async function addTaskComment() {
      if (!currentTaskId) return;

      const textarea = document.getElementById('new-comment-text');
      const content = textarea.value.trim();

      if (!content) {
        Utils.showError('è«‹è¼¸å…¥è©•è«–å…§å®¹');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/tasks/${currentTaskId}/comments`, {
          method: 'POST',
          headers: Utils.getAuthHeaders(),
          body: JSON.stringify({ content })
        });

        if (!response.ok) {
          throw new Error('æ–°å¢è©•è«–å¤±æ•—');
        }

        Utils.showSuccess('è©•è«–å·²ç™¼é€');
        textarea.value = '';
        
        // é‡æ–°è¼‰å…¥è©•è«–
        await loadTaskComments(currentTaskId);

      } catch (error) {
        console.error('æ–°å¢è©•è«–å¤±æ•—:', error);
        Utils.showError('æ–°å¢è©•è«–å¤±æ•—');
      }
    }

    // ç™»å‡º
    function logout() {
      Utils.confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', () => {
        api.clearAuth();
        window.location.href = 'index.html';
      });
    }

    // é»æ“Š Modal èƒŒæ™¯é—œé–‰
    ['add-task-modal', 'add-member-modal', 'edit-project-modal', 'task-detail-modal'].forEach(modalId => {
      const modal = document.getElementById(modalId);
      modal.addEventListener('click', (e) => {
        if (e.target.id === modalId) {
          modal.classList.add('hidden');
        }
      });
    });

    // ESC éµé—œé–‰ Modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideTaskModal();
        hideMemberModal();
        hideEditProjectModal();
        hideTaskDetailModal();
      }
    });

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadProject();
  </script>
</body>
</html>