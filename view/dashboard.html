<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Team Task Manager</title>
  <link rel="stylesheet" href="./style/style.css">
</head>
<body>
  <div class="navbar">
    <h1>Team Task Manager</h1>
    <div class="nav-right">
      <button onclick="goToMyTasks()" class="btn-secondary">ğŸ“‹ æˆ‘çš„ä»»å‹™</button>
      <button onclick="goToProfile()" class="btn-secondary">ğŸ‘¤ å€‹äººè³‡æ–™</button>
      <span id="username"></span>
      <button onclick="logout()" class="btn-secondary">ç™»å‡º</button>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h2>æˆ‘çš„å°ˆæ¡ˆ</h2>
      <button onclick="showCreateProjectModal()" class="btn-primary">+ æ–°å¢å°ˆæ¡ˆ</button>
    </div>

    <div id="projects-container" class="projects-grid"></div>

    <!-- å»ºç«‹å°ˆæ¡ˆ Modal -->
    <div id="create-project-modal" class="modal hidden">
      <div class="modal-content">
        <h3>å»ºç«‹æ–°å°ˆæ¡ˆ</h3>
        <form id="create-project-form">
          <input type="text" id="project-name" placeholder="å°ˆæ¡ˆåç¨±" required>
          <textarea id="project-description" placeholder="å°ˆæ¡ˆæè¿°ï¼ˆé¸å¡«ï¼‰" rows="3"></textarea>
          <div class="modal-actions">
            <button type="submit" class="btn-primary">å»ºç«‹</button>
            <button type="button" onclick="hideCreateProjectModal()" class="btn-secondary">
              å–æ¶ˆ
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥ JS -->
  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/utils.js"></script>
  
  <script>
    const user = Utils.getCurrentUser();
    
    // é¡¯ç¤ºä½¿ç”¨è€…åç¨±
    if (user) {
      document.getElementById('username').textContent = user.username;
    }

    // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
    async function loadProjects() {
      try {
        Utils.showLoading('è¼‰å…¥å°ˆæ¡ˆä¸­...');
        const data = await ProjectAPI.list();
        displayProjects(data.projects || []);
      } catch (error) {
        console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', error);
        Utils.showError(error.message || 'è¼‰å…¥å°ˆæ¡ˆå¤±æ•—');
        document.getElementById('projects-container').innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">ğŸ˜”</div>
            <div class="empty-state-text">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
          </div>
        `;
      } finally {
        Utils.hideLoading();
      }
    }

    // é¡¯ç¤ºå°ˆæ¡ˆ
    function displayProjects(projects) {
      const container = document.getElementById('projects-container');
      
      if (projects.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">ğŸ“</div>
            <div class="empty-state-text">é‚„æ²’æœ‰å°ˆæ¡ˆï¼Œå»ºç«‹ç¬¬ä¸€å€‹å§ï¼</div>
            <button onclick="showCreateProjectModal()" class="btn-primary">
              + æ–°å¢å°ˆæ¡ˆ
            </button>
          </div>
        `;
        return;
      }

      container.innerHTML = projects.map(project => `
        <div class="project-card" onclick="goToProject(${project.id})">
          <h3>${Utils.escapeHtml(project.name)}</h3>
          <p class="project-desc">
            ${project.description ? Utils.escapeHtml(project.description) : 'æ²’æœ‰æè¿°'}
          </p>
          <div class="project-stats">
            <span>ğŸ‘¥ ${project.member_count} æˆå“¡</span>
            <span>ğŸ“‹ ${project.completed_task_count}/${project.task_count} ä»»å‹™å®Œæˆ</span>
          </div>
          <div class="project-meta">
            <span class="badge ${project.my_role === 'admin' ? 'badge-admin' : 'badge-member'}">
              ${Utils.getRoleText(project.my_role || 'member')}
            </span>
            <span class="text-muted">by ${Utils.escapeHtml(project.owner.username)}</span>
          </div>
        </div>
      `).join('');
    }

    // å‰å¾€å°ˆæ¡ˆè©³æƒ…
    function goToProject(projectId) {
      window.location.href = `project.html?id=${projectId}`;
    }

    // å‰å¾€æˆ‘çš„ä»»å‹™
    function goToMyTasks() {
      window.location.href = 'my-tasks.html';
    }

    // å‰å¾€å€‹äººè³‡æ–™
    function goToProfile() {
      window.location.href = 'profile.html';
    }

    // é¡¯ç¤ºå»ºç«‹å°ˆæ¡ˆ Modal
    function showCreateProjectModal() {
      document.getElementById('create-project-modal').classList.remove('hidden');
      document.getElementById('project-name').focus();
    }

    // éš±è—å»ºç«‹å°ˆæ¡ˆ Modal
    function hideCreateProjectModal() {
      document.getElementById('create-project-modal').classList.add('hidden');
      document.getElementById('create-project-form').reset();
    }

    // å»ºç«‹å°ˆæ¡ˆ
    document.getElementById('create-project-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('project-name').value.trim();
      const description = document.getElementById('project-description').value.trim();

      if (!name) {
        Utils.showError('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
        return;
      }

      try {
        Utils.showLoading('å»ºç«‹ä¸­...');
        await ProjectAPI.create({ name, description });
        
        Utils.showSuccess('å°ˆæ¡ˆå·²å»ºç«‹');
        hideCreateProjectModal();
        loadProjects();
        
      } catch (error) {
        console.error('å»ºç«‹å°ˆæ¡ˆå¤±æ•—:', error);
        Utils.showError(error.message || 'å»ºç«‹å°ˆæ¡ˆå¤±æ•—');
      } finally {
        Utils.hideLoading();
      }
    });

    // ç™»å‡º
    function logout() {
      Utils.confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ', () => {
        api.clearAuth();
        window.location.href = 'index.html';
      });
    }

    // é»æ“Š Modal èƒŒæ™¯é—œé–‰
    document.getElementById('create-project-modal').addEventListener('click', (e) => {
      if (e.target.id === 'create-project-modal') {
        hideCreateProjectModal();
      }
    });

    // ESC éµé—œé–‰ Modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideCreateProjectModal();
      }
    });

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadProjects();
  </script>
</body>
</html>