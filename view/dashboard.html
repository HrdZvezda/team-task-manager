<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Team Task Manager</title>
  <link rel="stylesheet" href="../style/style.css">
</head>
<body>
  <div class="navbar">
    <h1>Team Task Manager</h1>
    <div class="nav-right">
      <span id="username"></span>
      <button onclick="logout()" class="btn-secondary">ç™»å‡º</button>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h2>æˆ‘çš„å°ˆæ¡ˆ</h2>
      <button onclick="showCreateProjectModal()" class="btn-primary">+ æ–°å¢å°ˆæ¡ˆ</button>
    </div>

    <div id="projects-container" class="projects-grid"></div>

    <!-- å»ºç«‹å°ˆæ¡ˆ Modal -->
    <div id="create-project-modal" class="modal hidden">
      <div class="modal-content">
        <h3>å»ºç«‹æ–°å°ˆæ¡ˆ</h3>
        <input type="text" id="project-name" placeholder="å°ˆæ¡ˆåç¨±" required>
        <textarea id="project-description" placeholder="å°ˆæ¡ˆæè¿° (é¸å¡«)" rows="3"></textarea>
        <div class="modal-actions">
          <button onclick="createProject()" class="btn-primary">å»ºç«‹</button>
          <button onclick="hideModal()" class="btn-secondary">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // const API_URL = 'https://team-task-manager-lr5e.onrender.com';
    const API_URL = 'http://127.0.0.1:8888';
    let token = localStorage.getItem('token');
    let user = JSON.parse(localStorage.getItem('user') || '{}');

    console.log('Dashboard è¼‰å…¥');
    console.log('Token:', token ? token.substring(0, 50) + '...' : 'null');
    console.log('User:', user);

    // æª¢æŸ¥ç™»å…¥
    if (!token || token === 'null' || token === 'undefined') {
      console.error('Token ç„¡æ•ˆ,è·³è½‰åˆ°ç™»å…¥é ');
      alert('è«‹å…ˆç™»å…¥');
      window.location.href = 'index.html';
    }

    // é¡¯ç¤ºä½¿ç”¨è€…åç¨±
    document.getElementById('username').textContent = user.username;

    // è¼‰å…¥å°ˆæ¡ˆåˆ—è¡¨
    async function loadProjects() {
      // æª¢æŸ¥ token
      if (!token || token === 'null' || token === 'undefined') {
        console.error('Token ç„¡æ•ˆ:', token);
        alert('ç™»å…¥ç‹€æ…‹ç„¡æ•ˆ,è«‹é‡æ–°ç™»å…¥');
        logout();
        return;
      }

      console.log('ä½¿ç”¨çš„ token:', token.substring(0, 30) + '...');

      try {
        const response = await fetch(`${API_URL}/projects`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Projects API status:', response.status);

        if (response.status === 401) {
          console.error('Token ç„¡æ•ˆæˆ–å·²éæœŸ');
          alert('ç™»å…¥å·²éæœŸ,è«‹é‡æ–°ç™»å…¥');
          logout();
          return;
        }

        const data = await response.json();
        console.log('Projects data:', data);
        displayProjects(data.projects);
        
      } catch (error) {
        console.error('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—:', error);
        alert('è¼‰å…¥å°ˆæ¡ˆå¤±æ•—');
      }
    }

    // é¡¯ç¤ºå°ˆæ¡ˆ
    function displayProjects(projects) {
      const container = document.getElementById('projects-container');
      
      if (projects.length === 0) {
        container.innerHTML = '<p class="empty-state">é‚„æ²’æœ‰å°ˆæ¡ˆ,å»ºç«‹ç¬¬ä¸€å€‹å§!</p>';
        return;
      }

      container.innerHTML = projects.map(project => `
        <div class="project-card" onclick="goToProject(${project.id})">
          <h3>${project.name}</h3>
          <p class="project-desc">${project.description || 'æ²’æœ‰æè¿°'}</p>
          <div class="project-stats">
            <span>ğŸ‘¥ ${project.member_count} æˆå“¡</span>
            <span>ğŸ“‹ ${project.completed_task_count}/${project.task_count} ä»»å‹™å®Œæˆ</span>
          </div>
          <div class="project-meta">
            <span class="badge ${project.my_role === 'admin' ? 'badge-admin' : 'badge-member'}">
              ${project.my_role === 'admin' ? 'ç®¡ç†å“¡' : 'æˆå“¡'}
            </span>
            <span class="text-muted">by ${project.owner.username}</span>
          </div>
        </div>
      `).join('');
    }

    // å‰å¾€å°ˆæ¡ˆè©³æƒ…
    function goToProject(projectId) {
      window.location.href = `project.html?id=${projectId}`;
    }

    // é¡¯ç¤ºå»ºç«‹å°ˆæ¡ˆ Modal
    function showCreateProjectModal() {
      document.getElementById('create-project-modal').classList.remove('hidden');
    }

    // éš±è— Modal
    function hideModal() {
      document.getElementById('create-project-modal').classList.add('hidden');
      document.getElementById('project-name').value = '';
      document.getElementById('project-description').value = '';
    }

    // å»ºç«‹å°ˆæ¡ˆ
    async function createProject() {
      const name = document.getElementById('project-name').value;
      const description = document.getElementById('project-description').value;

      if (!name.trim()) {
        alert('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/projects`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, description })
        });

        if (response.ok) {
          hideModal();
          loadProjects();
        } else {
          const data = await response.json();
          alert(data.error || 'å»ºç«‹å¤±æ•—');
        }
      } catch (error) {
        alert('ç¶²è·¯éŒ¯èª¤');
      }
    }

    // ç™»å‡º
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadProjects();
  </script>
</body>
</html>
